---
import type { Translation } from "@/i18n/types";
import type { GalleryImage } from "@/data/galleryImages";
import CarrucelGalery from "@/components/CarrucelGalery.astro";
import { getPreviewImages } from "@/data/galleryImages";

interface Props {
    translations: Translation;
}

const { translations: t } = Astro.props;

// Obtener solo las primeras 5 imágenes
const allPreviewImages = getPreviewImages();
const previewImages = allPreviewImages.slice(0, 5);

// Función para obtener la URL de la galería completa según el idioma actual
function getGalleryUrl() {
    const pathname = Astro.url.pathname;
    if (pathname.startsWith("/en")) return "/en/galeria";
    if (pathname.startsWith("/es")) return "/es/galeria";
    return "/galeria";
}

const galleryUrl = getGalleryUrl();
---

<section class="bg-primary py-16 px-4">
    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-12">
            <h2
                class="text-secondary text-3xl md:text-4xl lg:text-5xl font-light uppercase mb-4"
            >
                {t.gallery}
            </h2>
            <p class="text-secondary/80 text-lg md:text-xl max-w-2xl mx-auto">
                {t.galleryDescription}
            </p>
        </div>

        <!-- Preview Gallery - Solo primeras 5 imágenes -->
        <div class="relative mb-12">
            <!-- Carrusel horizontal -->
            <div
                id="gallery-carousel"
                class="flex gap-6 overflow-x-auto scroll-smooth pb-4 px-2 snap-x snap-mandatory"
                style="scrollbar-width: none; -ms-overflow-style: none;"
            >
                {
                    previewImages.map((image, index) => (
                        <div class="flex-shrink-0 w-72 sm:w-80 md:w-72 snap-center">
                            <CarrucelGalery
                                src={image.src}
                                alt={image.alt}
                                className={
                                    index < 3 ? "priority-load" : "lazy-load"
                                }
                            />
                        </div>
                    ))
                }
            </div>

            <!-- Puntos indicadores -->
            <div class="flex justify-center mt-8 gap-2">
                {
                    previewImages.map((_, index) => (
                        <button
                            class="carousel-dot w-3 h-3 rounded-full bg-secondary/30 hover:bg-secondary/60 transition-colors duration-300 touch-manipulation p-2"
                            data-index={index}
                            aria-label={`Ir a imagen ${index + 1}`}
                        />
                    ))
                }
            </div>

            <!-- Botones de navegación (ocultos en móvil) -->
            <button
                id="prev-btn"
                class="hidden md:block absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 bg-secondary/80 hover:bg-secondary text-primary p-3 rounded-full shadow-lg transition-all duration-300 z-10 touch-manipulation"
                aria-label="Imagen anterior"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>

            <button
                id="next-btn"
                class="hidden md:block absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 bg-secondary/80 hover:bg-secondary text-primary p-3 rounded-full shadow-lg transition-all duration-300 z-10 touch-manipulation"
                aria-label="Siguiente imagen"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
        </div>

        <!-- Botón para ver toda la galería -->
        <div class="text-center">
            <button
                id="view-all-btn"
                class="inline-flex items-center gap-3 bg-secondary text-third px-8 py-4 rounded-full font-semibold text-lg hover:bg-secondary/90 hover:scale-105 transform transition-all duration-300 shadow-lg hover:shadow-xl group relative overflow-hidden"
            >
                <!-- Texto normal -->
                <span id="btn-text" class="flex items-center gap-3">
                    <svg
                        class="w-6 h-6 group-hover:rotate-12 transition-transform duration-300"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                        ></path>
                    </svg>
                    {t.viewAllGallery}
                    <svg
                        class="w-5 h-5 group-hover:translate-x-1 transition-transform duration-300"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                    </svg>
                </span>

                <!-- Spinner de carga (oculto inicialmente) -->
                <span id="btn-loading" class="hidden items-center gap-3">
                    <div
                        class="animate-spin rounded-full h-6 w-6 border-b-2 border-third"
                    >
                    </div>
                    <span>Cargando galería...</span>
                </span>

                <!-- Overlay de carga -->
                <div
                    id="btn-overlay"
                    class="absolute inset-0 bg-secondary/80 hidden"
                >
                </div>
            </button>
        </div>
    </div>
</section>

<!-- Modal de carga global -->
<div
    id="global-loading"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center"
>
    <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-sm mx-4 text-center">
        <div
            class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"
        >
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">
            Cargando galería
        </h3>
        <p class="text-gray-600">
            Estamos preparando todas las imágenes para ti...
        </p>
    </div>
</div>

<script is:inline define:vars={{ galleryUrl }}>
    function initGalleryCarousel() {
        const carousel = document.getElementById("gallery-carousel");
        const dots = document.querySelectorAll(".carousel-dot");
        const prevBtn = document.getElementById("prev-btn");
        const nextBtn = document.getElementById("next-btn");
        const viewAllBtn = document.getElementById("view-all-btn");
        const globalLoading = document.getElementById("global-loading");

        if (!carousel || !dots.length) return;

        let currentIndex = 0;
        let isScrolling = false;
        let scrollTimeout;

        // Calcular ancho de item dinámicamente
        function getItemWidth() {
            const firstItem = carousel.querySelector(".flex-shrink-0");
            if (!firstItem) return 320;
            const styles = window.getComputedStyle(firstItem);
            const width = firstItem.offsetWidth;
            const marginRight = parseInt(styles.marginRight) || 0;
            return width + marginRight;
        }

        // Función para actualizar los puntos activos
        function updateDots(index) {
            dots.forEach((dot, i) => {
                if (i === index) {
                    dot.classList.remove("bg-secondary/30");
                    dot.classList.add("bg-secondary", "scale-125");
                } else {
                    dot.classList.remove("bg-secondary", "scale-125");
                    dot.classList.add("bg-secondary/30");
                }
            });
        }

        // Función para calcular el índice actual basado en scroll
        function getCurrentIndex() {
            const scrollLeft = carousel.scrollLeft;
            const itemWidth = getItemWidth();
            return Math.round(scrollLeft / itemWidth);
        }

        // Función para scroll hacia un índice específico
        function scrollToIndex(index) {
            if (isScrolling) return;

            isScrolling = true;
            const itemWidth = getItemWidth();
            const scrollPosition = index * itemWidth;

            carousel.scrollTo({
                left: scrollPosition,
                behavior: "smooth",
            });

            currentIndex = index;
            updateDots(index);

            setTimeout(() => {
                isScrolling = false;
            }, 500);
        }

        // Función para mostrar estado de carga
        function showLoadingState() {
            const btnText = document.getElementById("btn-text");
            const btnLoading = document.getElementById("btn-loading");
            const btnOverlay = document.getElementById("btn-overlay");

            if (btnText && btnLoading && btnOverlay) {
                btnText.classList.add("hidden");
                btnLoading.classList.remove("hidden");
                btnOverlay.classList.remove("hidden");
            }

            // Mostrar loading global
            if (globalLoading) {
                globalLoading.classList.remove("hidden");
                globalLoading.classList.add("flex");
            }
        }

        // Función para ocultar estado de carga
        function hideLoadingState() {
            const btnText = document.getElementById("btn-text");
            const btnLoading = document.getElementById("btn-loading");
            const btnOverlay = document.getElementById("btn-overlay");

            if (btnText && btnLoading && btnOverlay) {
                btnText.classList.remove("hidden");
                btnLoading.classList.add("hidden");
                btnOverlay.classList.add("hidden");
            }

            // Ocultar loading global
            if (globalLoading) {
                globalLoading.classList.add("hidden");
                globalLoading.classList.remove("flex");
            }
        }

        // Event listeners para los puntos
        dots.forEach((dot, index) => {
            dot.addEventListener("click", (e) => {
                e.preventDefault();
                scrollToIndex(index);
            });
        });

        // Event listeners para los botones de navegación
        if (prevBtn) {
            prevBtn.addEventListener("click", (e) => {
                e.preventDefault();
                const newIndex =
                    currentIndex > 0 ? currentIndex - 1 : dots.length - 1;
                scrollToIndex(newIndex);
            });
        }

        if (nextBtn) {
            nextBtn.addEventListener("click", (e) => {
                e.preventDefault();
                const newIndex =
                    currentIndex < dots.length - 1 ? currentIndex + 1 : 0;
                scrollToIndex(newIndex);
            });
        }

        // Event listener para el botón "Ver todos" - CON ESTADO DE CARGA
        if (viewAllBtn) {
            viewAllBtn.addEventListener("click", async (e) => {
                e.preventDefault();

                // Mostrar estado de carga
                showLoadingState();

                try {
                    // Pequeña espera para que se vea el loading
                    await new Promise((resolve) => setTimeout(resolve, 1000));

                    // Navegar a la galería completa
                    window.location.href = galleryUrl;
                } catch (error) {
                    console.error("Error al navegar:", error);
                    hideLoadingState();

                    // Fallback en caso de error
                    setTimeout(() => {
                        window.location.href = galleryUrl;
                    }, 500);
                }
            });
        }

        // También agregar loading al hacer click en las imágenes del carrusel
        const carouselImages = carousel.querySelectorAll("img");
        carouselImages.forEach((img) => {
            img.addEventListener("click", () => {
                showLoadingState();
                setTimeout(() => {
                    window.location.href = galleryUrl;
                }, 800);
            });
        });

        // Detectar scroll manual y actualizar puntos (con debounce)
        carousel.addEventListener(
            "scroll",
            () => {
                if (isScrolling) return;

                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const newIndex = getCurrentIndex();
                    if (
                        newIndex !== currentIndex &&
                        newIndex >= 0 &&
                        newIndex < dots.length
                    ) {
                        currentIndex = newIndex;
                        updateDots(newIndex);
                    }
                }, 100);
            },
            { passive: true },
        );

        // Manejar resize de ventana
        window.addEventListener(
            "resize",
            () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const newIndex = getCurrentIndex();
                    if (
                        newIndex !== currentIndex &&
                        newIndex >= 0 &&
                        newIndex < dots.length
                    ) {
                        currentIndex = newIndex;
                        updateDots(newIndex);
                    }
                }, 150);
            },
            { passive: true },
        );

        // Inicializar el primer punto como activo
        updateDots(0);
    }

    // Inicializar cuando el DOM esté listo
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initGalleryCarousel);
    } else {
        initGalleryCarousel();
    }

    // Re-inicializar después de navegación
    document.addEventListener("astro:page-load", initGalleryCarousel);
</script>

<style>
    #gallery-carousel::-webkit-scrollbar {
        display: none;
    }

    /* Smooth scrolling para Safari */
    #gallery-carousel {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior-x: contain;
    }

    /* Animación para los puntos */
    .carousel-dot {
        transition: all 0.3s ease;
    }

    /* Mejoras para touch */
    .touch-manipulation {
        touch-action: manipulation;
    }

    /* Optimización de imágenes */
    .priority-load img {
        loading: eager;
        fetchpriority: high;
    }

    .lazy-load img {
        loading: lazy;
        fetchpriority: low;
    }

    /* Placeholder para imágenes que cargan */
    img[loading="lazy"] {
        background: linear-gradient(
            90deg,
            #f0f0f0 25%,
            #e0e0e0 50%,
            #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }

    @keyframes loading {
        0% {
            background-position: 200% 0;
        }
        100% {
            background-position: -200% 0;
        }
    }

    /* Evitar selección de texto en botones */
    button {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    /* Animaciones para el botón de ver todos */
    #view-all-btn {
        background: linear-gradient(135deg, #814662 0%, #9d5a7a 100%);
        border: none;
        outline: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    #view-all-btn:hover {
        background: linear-gradient(135deg, #9d5a7a 0%, #b16d92 100%);
        box-shadow: 0 10px 25px rgba(129, 70, 98, 0.3);
    }

    #view-all-btn:active {
        transform: scale(0.98);
    }

    #view-all-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }

    /* Animación del spinner */
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .animate-spin {
        animation: spin 1s linear infinite;
    }

    /* Transiciones suaves */
    .transition-all {
        transition: all 0.3s ease;
    }

    /* Mejoras para el modal de carga */
    #global-loading {
        transition: opacity 0.3s ease;
    }

    /* Efecto de pulso para el botón durante la carga */
    @keyframes pulse {
        0%,
        100% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
    }

    .loading-pulse {
        animation: pulse 2s infinite;
    }
</style>
