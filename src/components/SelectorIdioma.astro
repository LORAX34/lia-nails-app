---
// Obtener el idioma actual de la URL
const currentPath = Astro.url.pathname;
const currentLang = currentPath.startsWith("/en")
    ? "en"
    : currentPath.startsWith("/es")
      ? "es"
      : "pt";

// ConfiguraciÃ³n de idiomas
const languages = [
    { code: "pt", name: "PortuguÃªs", flag: "ðŸ‡µðŸ‡¹", path: "/" },
    { code: "en", name: "English", flag: "ðŸ‡ºðŸ‡¸", path: "/en/" },
    { code: "es", name: "EspaÃ±ol", flag: "ðŸ‡ªðŸ‡¸", path: "/es/" },
];

// Obtener el resto de la ruta (despuÃ©s del idioma)
const pathWithoutLang = currentPath.replace(/^\/(en|es)/, "") || "/";
---

<div class="relative z-50">
    <div class="relative inline-block dropdown">
        <button
            class="flex items-center gap-2 px-4 py-2 bg-white bg-opacity-90 backdrop-blur-sm border border-gray-300 rounded-lg cursor-pointer transition-all duration-200 font-medium text-sm text-gray-700 shadow-sm hover:bg-opacity-100 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50"
            id="languageBtn"
        >
            <span class="flex items-center gap-1">
                <span class="text-base leading-none">
                    {languages.find((lang) => lang.code === currentLang)?.flag}
                </span>
                <span class="text-xs font-semibold uppercase tracking-wide">
                    {currentLang}
                </span>
            </span>
            <svg
                class="w-3 h-2 transition-transform duration-200 text-gray-500 chevron"
                viewBox="0 0 12 8"
                fill="none"
            >
                <path
                    d="M1 1.5L6 6.5L11 1.5"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
            </svg>
        </button>

        <div
            class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg opacity-0 invisible transform translate-y-1 transition-all duration-200 mt-1 overflow-hidden dropdown-menu min-w-max"
            id="languageMenu"
        >
            {
                languages.map((lang, index) => (
                    <a
                        href={
                            lang.code === "pt"
                                ? pathWithoutLang
                                : lang.path.slice(0, -1) + pathWithoutLang
                        }
                        class={`flex items-center gap-3 px-4 py-3 transition-all duration-150 text-sm font-medium no-underline hover:bg-gray-50 focus:outline-none focus:bg-gray-50 ${
                            lang.code === currentLang
                                ? "bg-primary bg-opacity-10 text-secondary font-semibold"
                                : "text-gray-700"
                        }`}
                        data-astro-prefetch
                        data-lang={lang.code}
                    >
                        <span class="text-base leading-none">{lang.flag}</span>
                        <span class="whitespace-nowrap">{lang.name}</span>
                        {lang.code === currentLang && (
                            <svg
                                class="w-4 h-4 text-primary ml-auto"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                    clip-rule="evenodd"
                                />
                            </svg>
                        )}
                    </a>
                ))
            }
        </div>
    </div>
</div>

<style>
    .dropdown.open .chevron {
        transform: rotate(180deg);
    }

    .dropdown.open .dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .dropdown button {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        .dropdown-menu a {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
        }
    }

    /* Prevenir FOUC - estilos inline crÃ­ticos */
    .dropdown {
        display: inline-block;
        position: relative;
    }

    .dropdown button {
        background-color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        border: 1px solid rgb(209, 213, 219);
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        color: rgb(55, 65, 81);
        cursor: pointer;
        transition: all 0.2s;
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid rgb(209, 213, 219);
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        margin-top: 0.25rem;
        opacity: 0;
        visibility: hidden;
        transform: translateY(4px);
        transition: all 0.2s;
        min-width: max-content;
        overflow: hidden;
        z-index: 50;
    }

    .dropdown-menu a {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: rgb(55, 65, 81);
        text-decoration: none;
        transition: all 0.15s;
        white-space: nowrap;
    }

    .dropdown-menu a:hover {
        background-color: rgb(249, 250, 251);
    }
</style>

<script is:inline>
    function initLanguageSelector() {
        // Funcionalidad del dropdown
        const languageBtn = document.getElementById("languageBtn");
        const languageMenu = document.getElementById("languageMenu");
        const dropdown = document.querySelector(".dropdown");

        if (!languageBtn || !languageMenu || !dropdown) return;

        // Limpiar event listeners existentes
        const newLanguageBtn = languageBtn.cloneNode(true);
        languageBtn.parentNode?.replaceChild(newLanguageBtn, languageBtn);

        const newDropdown = dropdown.cloneNode(true);
        dropdown.parentNode?.replaceChild(newDropdown, dropdown);

        // Re-obtener elementos despuÃ©s de clonar
        const btn = document.getElementById("languageBtn");
        const menu = document.getElementById("languageMenu");
        const dropdownEl = document.querySelector(".dropdown");

        if (!btn || !menu || !dropdownEl) return;

        // Toggle dropdown
        btn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropdownEl.classList.toggle("open");
        });

        // Cerrar dropdown al hacer click fuera
        document.addEventListener("click", (e) => {
            if (!dropdownEl.contains(e.target)) {
                dropdownEl.classList.remove("open");
            }
        });

        // Cerrar dropdown con Escape
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                dropdownEl.classList.remove("open");
            }
        });

        // NavegaciÃ³n con teclado
        const dropdownItems = menu.querySelectorAll("a");
        let currentIndex = -1;

        btn.addEventListener("keydown", (e) => {
            if (e.key === "ArrowDown" || e.key === "ArrowUp") {
                e.preventDefault();
                dropdownEl.classList.add("open");

                if (e.key === "ArrowDown") {
                    currentIndex = 0;
                } else {
                    currentIndex = dropdownItems.length - 1;
                }

                dropdownItems[currentIndex]?.focus();
            }
        });

        dropdownItems.forEach((item, index) => {
            item.addEventListener("keydown", (e) => {
                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    currentIndex = (index + 1) % dropdownItems.length;
                    dropdownItems[currentIndex].focus();
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    currentIndex =
                        index - 1 < 0 ? dropdownItems.length - 1 : index - 1;
                    dropdownItems[currentIndex].focus();
                } else if (e.key === "Enter") {
                    e.preventDefault();
                    item.click();
                }
            });
        });
    }

    // Inicializar cuando el DOM estÃ© listo
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initLanguageSelector);
    } else {
        initLanguageSelector();
    }

    // Re-inicializar despuÃ©s de navegaciÃ³n con delay para evitar FOUC
    document.addEventListener("astro:page-load", () => {
        setTimeout(initLanguageSelector, 50);
    });

    // Prevenir FOUC aplicando estilos inmediatamente
    document.addEventListener("astro:before-preparation", () => {
        const selector = document.querySelector(".dropdown");
        if (selector) {
            selector.style.visibility = "hidden";
        }
    });

    document.addEventListener("astro:after-preparation", () => {
        const selector = document.querySelector(".dropdown");
        if (selector) {
            selector.style.visibility = "visible";
        }
    });
</script>
